<div dir="rtl">

# چطور تونستم مشکل WSL2 رو حل کنم؟

## قسمت اول راهنمای نصب WSL2

![banner](./images/virgool-post.png)

### **مقدمه**

نمیدونم اینجا آیا کسی هست که مثل من دنیای لینوکس رو با طمع مایکروسافت چشیده باشه؟ شاید لینوکس بازهای حرفه ای بگن عجب طمع تلخ و بدمزه ای اصلا چطور میشه توی یک دیس غذای مایکروسافت رو با لینوکس مخلوط کرد این یک توهین بزرگ به تمام مزه های جهان بود

اما من کسی بودم که فقط میگفت david david [microsoft](https://www.microsoft.com) و اصلا هیچ چیزی جز مایکروسافت توی کلش فرو نمیرفت تا اینکه یک روز بچه های ردموند به واقعیت قدرتمندی لینوکس [اعتراف کردن](https://www.zoomit.ir/2020/5/18/348674/microsoft-wrong-open-source-linux/) و این شد که من از معجزه لینوکس و دنیای لینوکس آشنا شدم

![microsoft love linux](./images/msLoveLinux.png)

امروز میخوام مثل همیشه که وقتی چیزی رو بلد میشم مثل مته توی مخم می افته و تا با کسی به اشتراک نزارم آروم نمیگیرم، مطالبم رو با شما به اشتراک بزارم

دوست دارم در دو قسمت از آسون به کمی سخت حرکت کنم تا دوستان مایکروسافتی از طمع دلنشین لینوکس در ویندوز غافل نمونن

ابتدا مسیر خودم رو با نصب WSL2 شروع میکنم و در نهایت به مسئله و چالش بزرگ حل تنها مشکل آزاردهنده لینوکس بر روی ویندوز میرم تا شما رو هم از شر این مشکل منحوس راحت کنم

### **اصلا WSL یعنی چی؟**

کلمه WSL مخفف `windows subsystem for linux` هست که به شما اجازه میده بتونید بر روی سیستم خودتون طمع لینوکس یا همون اوبونتو رو بچشید

و به همین دلیل به `WSL` معروف هست که در آخرین بیلد ویندوز یعنی 2004 شما میتونید ورژن 2 لینوکس رو داشته باشید

ورژن دوم این WSL کاملا با نسخه اولیه متفاوت هست، در نسخه اولیه یک پرتابل لینوکس بر روی سیستم بود که به شما اجازه دسترسی به همه چیز رو نمیداد و یک چیز ناقص بود. فقط یک حرکت کوچیک از سمت مایکروسافت بود

اما در ورژن دوم همه چیز متفاوت شد حالا شما یک کرنل کامل از لینوکس رو در اختیار دارید و به طرز عجیبی شما یک سیستم عامل رو بر روی ماشین مجازی نصب میکنید اما طمع تلخ ماشین مجازی رو به شما نمیده

همه ما میدونیم که ماشین های مجازی مشکلات متعددی رو در مصرف منابع دارن و از این رو خیلی ها به سمت ماشین مجازی نمیرن اما در WSL2 کاملا همه چیز برعکسه و انگار که نرم افزار ms paint رو بر روی سیستم خودتون ران کردید ( در این حد سبکه)

پس ما فهمیدیم که ورژن دوم `WSL` روی یک ماشین مجازی یا همون `Hyper-v` نصب میشه

بریم با همدیگه شروع به نصب لینوکس کنیم

### **قدم اول چک کنید که ویندوز شما ورژن 2004 باشه**

همه ما میدونیم که WSL2 از بیلد 2004 به بعد فعال میشه 

پس برای اینکار با فشردن کلید های ترکیبی `windows + r` پنجره `Run` رو باز کنید و بنویسید `winver` و اینتر کنید صفحه ای نمایان میشود و باید چیزی شبیه به ورژن پایین باشد

![modal to show windows version](./images/winVer.png)

اگر اینطور نیست سریعا اقدام به آپدیت دستگاه کنید که از طریق windows update اینکار قابل انجام هست

اگر هم میخواهید بدونید چه تعییراتی در این ورژن وجود داشته به [این لینک ](https://www.neowin.net/news/windows-10-version-2004-is-coming---heres-what-you-need-to-know-about-it/)  برید
### **قدم دوم تغییر نام host name ویندوز**

لینوکس همیشه برای ارتباط با دستگاه دیگه از یک host name استفاده میکنه و حتی اون رو بر روی ترمینال شما پرینت میگیره به همین دلیل WSL از نام ویندوز استفاده میکنه

پس ابتدا وارد بخش زیر بشید و یک نام کاملا unique که در هیچ دیوایس دیگه ای استفاده نکردید رو به سیستم خودتون بدید و در نهایت از شما میخواد که سیستم رو ری استارت کنید

**اما شما اینکار رو نمیکنید**

پنجره `run` رو باز کنید (برای اینکار از کلید ترکیبی `windows + r` استفاده کنید)

و حالا تایپ کنید `sysdm.cpl` و پنجره ای ظاهر میشه وارد تب computer name شوید و بر روی دکمه change که پایین سمت راست هست کلید کنید دوباره پنجره ای باز میشه در بخش computer name نام مورد نظر خودتون رو وارد کنید

> هیچ وقت یادتون نره که نامی رو که برای کامپیوتر خودتون انتخاب میکنید یک نام کاملا unique باید باشه و در هیچ دیوایس دیگه ای استفاده نکرده باشید

![modal for changing computer name](./images/computerName.png)

وقتی به شما اخطار ری استارت کردن رو داد به هیچ عنوان ری استارت نکنید تا مرحله بعد رو هم به اتمام برسونیم اما پنجره اخطار ری استارت رو نبندید بلکه نیازش داریم

### **قدم سوم فعال سازی feature های ویندوز**

اینجا مهم ترین بخش نصب هست 

ابتدا وارد search بشید و تایپ کنید `features` و برای شما یک آیکون همراه با نامی `turn windows features on or off` میاره بر روی اون کلیک کنید تا صفحه کوچکی نمایان شود

سپس گزینه هایی که در زیر هست رو پیدا کنید و تیک بزنید

<div dir="ltr">

```
Hyper-V
    Hyper-V Management Tools
    Hyper-V Platform

Virtual Machine Platform

Windows Subsystem for Linux
```
</div>

در هنگامی که تیک Hyper-v رو میزنید اون رو از حالت collapse با کلیک کردن بر روی + خارج کنید و زیر مجموعه های اون رو هم تیک بزنید

و بعد از اون حالا وقت **ری استارت** فرا رسیده است

پس ری استارت کرده و بگذارید ماشین شما تمام تغییرات رو ثبت کنه

### **قدم چهارم نصب پیش نیازها**

برای اینکه بتونیم محیط ترمینال Ubuntu رو داشته باشیم و اینکه در قسمت های بعدی که میخواهیم چیزهایی رو اضافه کنیم در همین بخش به دانلود تمامی پیش نیازها میپردازیم

> توجه داشته باشید که هر چیزی رو که دانلود میکنید رو نصب نکنید تا زمانی که وقتش برسه و خودم در مطلب اشاره میکنم

بعضی از سیستم ها نیازمند این هست که کرنل wsl رو به صورت دستی آپدیت کنیم تا پذیرای WSL2 بشه

پس این فایل رو دانلود کنید 

#### [WSL2_Kernel](https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi)

برای فصل بعدی که بسیار مهم هست نیازمند نصب `powershell 7.0` هستیم

#### [Powershell_7.0](https://github-production-release-asset-2e65be.s3.amazonaws.com/49609581/5a5c1280-abe7-11ea-88a2-4815f124fd42?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20200624%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20200624T074332Z&X-Amz-Expires=300&X-Amz-Signature=6cb246b937af1d2fe6c69ed241fad6aee49783a0bbf3b83e124d44c26338f5ce&X-Amz-SignedHeaders=host&actor_id=25862601&repo_id=49609581&response-content-disposition=attachment%3B%20filename%3DPowerShell-7.0.2-win-x64.msi&response-content-type=application%2Foctet-stream)

و حالا وارد استور میشیم و به نصب دو چیز میپردازیم 

<div dir="ltr">

1- Ubuntu 20.04 LTS

2- Windows Terminal
</div>

که هر دوی اینها درون استور مهیا هستند و فقط کافی هست که شما اونها رو نصب کنید

![ubuntu 20.04 LTS in windows store](./images/ubuntu.png)

![windows terminal in windows store](./images/windowsTerminal.png)

خب حالا ما دو فایل نصبی و یک اوبونتو و یک ویندوز ترمینال رو در اختیار داریم حالا وقت این هست که وارد بخش نصب اولیه بشیم

### **قدم پنجم تبدیل WSL به WSL2**

ابتدا ubuntu یی که بر روی سیستم نصب کردیم رو ران میکنیم سپس پنجره ای شبیه به `CMD` ران میشود و بر روی اون اخطاری نوشته شده است از اینکه بگذارید سیستم نصب اولیه اوبونتو رو خودش انجام بده پس سیستم رو به حال خودش رها میکنیم تا زمانی که صفحه مورد نظر از ما درخواست وارد کردن نام کاربری و پسورد کنه

یعنی به این شکل

<div dir="ltr">

```
Enter UNIX username: 

Enter UNIX password:
```
</div>

این رو برای اونهایی مینویسم که تا بحال با محیط لینوکس آشنا نیستن 

اول اینکه یوزرنیم خیلی مهمه پس چیزی رو انتخاب کنید که unique باشه و دوم اینکه پسورد رو یک جا بنویسید چرا که در هر مرحله از کار از شما درخواست وارد کردن پسورد میکنه پس فراموش کردنش عملا همه کارها رو میریزونه بهم

> و در نهایت هنگام تایپ پسورد شما هیچ چیزی رو نمیبینید درون ترمینال چاپ شود حتی شما *** همچین شکلی رو هم نمیبینید پس فکر نکنید که کیبورد مشکلی داره یا ترمینال بلکه این حالت  لینوکس هست پس به تایپ خودتون ادامه بدید

![asking for password and username for the first use](./images/ubuntuTerminal.png)

خب اگر همه چیز به درستی جلو رفته باشه باید شما `shell prompt` رو ببینید یعنی به این شکل

<div dir="ltr">

```
yourUserName@yourComputerName:~

chris@awesomePc:~

illustray@jumboKing:~
```
</div>

حالا وقت اون رسیده که وارد بحث این بشیم که WSL خودمون رو به ورژن 2 ببریم

روی استارت کلیک راست کنید و بر روی `windows Powershell (Admin)` کلیک کنید

سپس دستور زیر را وارد کنید 

<div dir="ltr">

```
wsl -l -v
```
</div>

با این دستور متوجه میشیم که ورژن و نام اوبونتو نصب شده بر روی سیستم چی هست

پس خروجی به این شکل میشود

<div dir="ltr">

```
  NAME            STATE           VERSION
* Ubuntu-20.04    Running         1
```
</div>

خب حالا که نام اوبونتو رو میدونیم و میبینم که ورژن ما هنوز 1 هست اون رو تغییر میدیم به ورژن 2 با دستور زیر

<div dir="ltr">

```
wsl --set-version Ubuntu-20.04 2
```
</div>

خب ابتدا از دستور WSL استفاده میکنیم و از option `--set-version` برای تغییر ورژن استفاده میکنیم سپس نام توزیعی رو که توسط دستور قبل پرینت گرفتیم رو مینویسم و با زدن یک اسپس عدد 2 رو چاپ میکنیم که اینطوری من میگم که این توزیع رو وارد ورژن 2 کن

اما ممکنه همون لحظه به شما اروری بده مبنی بر اینکه ابتدا باید kernel رو آپدیت کنید چیزی شبیه به ارور زیر

<div dir="ltr">

```
WSL2 requires an update to its kernel component. for more ......
```
</div>

اگر همچین اروری رو داد اقدام به نصب فایلی میکنیم که در موضوع قبل اون رو دانلود کردیم یعنی [WSL2 Kernel](#-WSL2_Kernel) و سپس اقدام دوباره به اجرا دستور قبل میکنیم

هنگام نصب هیچ کاری نباید انجام داد ممکن هست حدود 10 الی 15 دقیقه طول بکشه که کارش رو تموم کنه و شایدم خیلی زودتر اما صبور باشید

## قسمت دوم حل مشکل WSL2

### مقدمه قسمت دوم

خب رسیدیم به مهم ترین بخش لینوکس یعنی حل مشکلی که بخاطرش `issue` های متفاوتی باز شده و هنوز هم در مورد این مشکل صحبت میشه

دوستان لطفا نرم افزار `windows terminal` رو باز کنید و بر روی فلشی که به سمت پایین هست کلیک کنید که منویی نمایش داده میشود در اون بخش بر روی اوبونتو کلیک کنید تا ابونتو ران شود

![windows terminal menu](./images/ubuntuContext.png)

سپس دستور زیر رو تایپ کنید

<div dir="ltr">

```
ip -4 a | grep '172.'
```
</div>

برای شما محتوایی شبیه به این شکل پرینت میگیره 

<div dir="ltr">

```
    inet 172.20.175.208/20 brd 172.20.175.255 scope global eth0
```
</div>

خب این مشکل بزرگ ما هست این همون چیزی هست که سرش دعوا هستش

متاسفانه به علت اینکه اوبونتو بر روی ماشین مجازی نصب هست تمام رد و بدل های این ماشین `internal` هست و چیزی به نام خروج وجود نداره شما میتونید با ویندوز ارتباط داشته باشید اما کسی و یا دیوایسی از بیرون نمیتونه با شما ارتباط داشته باشه 

بر روی سرچ ویندوز کلیک کنید و عبارت `hyper-v manager` رو تایپ کنید و بر روی اون کلیک کنید 

صفحه ای نمایان میشود که سمت راست این صفحه گزینه ای به نام `Virtual Switch Manager` وجود دارد بر روی آن کلیک کنید و صفحه ای نمایان میشود

![Hyper-V manager window](./images/virtual.png)

کافی هست که به بخش `WSL` بریم میبینیم که WSL در حالت internal هست یعنی اینکه چیزی به نام ارتباط با محیط خارج از ویندوز و یا با دیوایس دیگه وجود نداره

![virtual switch manager page](./images/internal.png)

خب الان به خودتون میگید کاری نداره من میبرش روی حالت `external` و تمام!! 

اما مشکل از اینجا شروع میشه که به محض اینکه شما کانکشن ویندوز رو به اوبونتو میدید و بعد که کارتون به اصطلاح تموم میشه و یا دلتون میخواد سیستم رو ری استارت کنید فاجعه رخ میده

به اصطلاح ویندوز، سیستم عامل `aggresive` میشه و همه چیزو بهم میریزه و ناگهان وقتی سیستم رو دوباره روشن میکنید میبینید که کانکشن شما این شکلی شده و اصلا نه در ویندوز و نه در اوبونتو کانکشنی با دنیای اینترنت ندارید و همه چیز بهم ریخته

![aggressive connection without any configuration](./images/noConnection.png)

خب بریم جای دیگه ای رو هم نگاه کنیم

به محض اینکه شما اوبونتو رو ران میکنید خود اوبنتو برای شما یک کانکشن به نام `vEthernet WSL` رو میسازه 

یعنی شما در بخش کانکشن های خودتون یک Ethernet یا wireless Ethernet دارید و دو تا کانکش دیگه که یکی مختص ماشین مجازی و دیگری مختص اوبونتو هست و این کانکشن از کلاس `B` استفاده میکنه و هیچ اجازه ای به شما نمیده که از طریق خارج از دیوایس و یا حتی خارج از محیط network دسترسی داشته باشید

![all windows and WSL internet connections](./images/adaptors.png)

خب داریم دیگه به آخر تور خودمون میرسیم 

کسانی که لینوکسی هستند میدونن که تمام DNS های اونها درون یک فایل به نام `resolv.conf` ثبت میشه

توی WSL مشکلی که وجود داره این هست که به محض اینکه شما ری استارت کنید بعلاوه اینکه تمام تنظیمات ریست میشه این فایل هم دوباره دستخوش تغییر میشه و به حالت اول بر میگرده یعنی عملا با بستن اوبونتو همه تغییرات از تغییر آی پی تا تغییر دی ان اس پاک میشه میره

درون اوبونتو دستور زیر رو تایپ کنید

<div dir="ltr">

```
cat /etc/resolv.conf
```
</div>

خب مقداری که برای شما پرینت میگیره به این شکل هست

<div dir="ltr">

```
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.20.160.1
```
</div>

خودش داره میگه که من `automatically generated` هستم درسته که خودش داره بهت میگه که اینکارو بکن که جلوی این حالت رو بگیری اما ماشین توجهی نداره و کار خودش رو میکنه


### **خب ما میخواهیم چه مشکلاتی رو حل کنیم؟**

1- میخواهیم کاری کنیم که WSL دارای آی پی با رنج کلاس `C` یا همون حالت `192.168.1.xxx` باشه

2- دلم میخواد ماشین مجازی من یعنی `WSL` از کانکشن `Ethernet` من هم استفاده کنه برای ارتباط گرفتن

3- دلم میخواد هیچ وقت فایل `resolv.conf` تغییر نکنه و اون چیزی بشه که من مینویسم براش

4- به کانکش ویندوز و اوبونتو دو آی پی جداگانه و `static` بدم و همیشه با اون رنج آی پی ها کار خودش رو شروع کنه

5- دلم میخواد تمامی این نکاتی رو که در بالا گفتم رو خود ویندوز انجام بده و نه من ( چون همونطوری که گفتم به محض ری استارت و یا خاموش کردن همه چیز ریست میشه و حتی بهتره بگیم بهم میریزه)


### **ایده من برای حل این مشکل**

من برای حل این مشکل از دو بخش کمک میگیرم 

<div dir="ltr">

- Powershell (powershell 7.0)

- windows Terminal
</div>

همونطوری که گفتم نیازمند این هستم که 

1- ویندوز دارای آی پی استاتیک باشه

2- اوبونتو هم دارای آی پی استاتیک باشه

3- بتونم دی ان اس اوبونتو رو تغییر بدم و هیچ تغییری نکنه

4- همه اینکارها رو خود ویندوز انجام بده و نه من و همیشه در حالت اتوماتیک باشه

**خب کانسپت من برای اینکار این هست**

ابتدا توسط `Powershell` به ویندوز میگم بیا کانکشن اصلی ویندوز رو بده به `WSL` خب اینجا شاید از خودتون بپرسید که این که شد همون که، حالا ویندوز بدبخت دیگه هیچ ارتباطی با بیرون نداره

اما یک اتفاق خیلی عجیبی اینجا رخ میده

ویندوز وقتی میبینه که دیگه کانکشنی وجود نداره میاد کانکشن WSL که معروف بود به `vEthernet WSL` رو ماله خودش میکنه و عملا کار ما رو راحت میکنه چرا که فقط این کانکشن نیازمند یک آی پی و دی ان اس هست تا ویندوز رو هم به اینترنت متصل کنه

قدم بعدی میام از طریق اوبونتو کانکشن همونی که آی پی رنجش توی `172` بود رو پیدا میکنم و بهش یک آی پی با رنج `192.168.1.xxx` میدم

سپس میام توی همین اوبونتو کاری میکنم که همیشه اون دی ان اسی که من میخوام رو برای اوبونتو مد نظر بگیره

و تمام اینها رو درون یک فایل `script` مینویسم و به ترمینال خودم میدم که هر بار که من ترمینال رو باز کردم خودش تمام تعریف های بالا ر وانجام بده بدون اینکه من دخالتی توی کار داشته باشم و تنها کاری که من باید بکنم این هست که ذره ای **صبور** باشم


### **قدم اول نصب Powershell 7.0**

در مطلب قبلی ما فایل [Powershell 7.0](#-Powershell_7.0) رو دانلود کردیم خب الان وقتش هست که اقدام به نصبش کنیم

نصب بسیار راحتی داره و فقط به این مرحله که در تصویر زیر هست رسیدید تیک هایی که من زدم رو شما هم بزنید

![powershell install page](./images/powershell.png)

</div>